name: YAML-00精靈

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  fetch_issues_and_create_m09:
    runs-on: ubuntu-latest

    steps:
      - name: 檢查並拉取程式碼
        uses: actions/checkout@v4

      - name: 安裝工具
        run: sudo apt-get update && sudo apt-get install -y gh jq

      - name: 抓取並生成 M09.json 檔案
        run: |
          echo "🚀 PD精靈啟動中... 正在處理任務清單"
          
          # 這裡就是關鍵！我們明確指定了文件的新位置
          urls=$(grep -Eo 'https://github\.com/[^ ]+' "inputs/823-任務清單.md")

          if [ -z "$urls" ]; then
            echo "❌ 錯誤：在輸入文件中找不到任何網址。請檢查檔案內容。"
            exit 1
          fi

          echo "[" > M09.json
          
          first_url=true
          for url in $urls; do
            if [ "$first_url" = false ]; then
              echo "," >> M09.json
            fi
            
            owner_repo=$(echo "$url" | awk -F'/issues' '{print $1}' | cut -d'/' -f4,5)
            issue_number=$(echo "$url" | awk -F'/' '{print $NF}')
            
            echo "➡️ 正在抓取 ${owner_repo}#${issue_number} 的資料..."
            
            # 使用 gh cli 抓取 JSON 資料
            gh issue view "${owner_repo}#${issue_number}" \
              --json number,title,body,comments,labels,assignees,createdAt,updatedAt,htmlUrl \
              >> M09.json
              
            first_url=false
          done
          
          echo "]" >> M09.json
          
          echo "✅ 任務完成！M09.json 已成功生成！"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 上傳情報檔案至 GitHub
        uses: actions/upload-artifact@v4
        with:
          name: 823-M09-情報檔案
          path: M09.json
