name: M09 Data Generator

on:
  workflow_dispatch:

jobs:
  gsac-task-processing:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl gpg jq
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
            | sudo gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
            | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install -y gh

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Verify input file exists
        run: ls bonus-tasks/823-task-list.md

      - name: Fetch issues and generate JSON
        run: |
          echo "[" > 823-M09-data.json
          count=0
          total=$(grep -c '^https://github.com/' bonus-tasks/823-task-list.md || echo 0)
          echo "Processing $total URLs"

          while read -r url; do
            [[ -z "$url" ]] && continue
            repo=${url#https://github.com/}
            repo=${repo%/issues*}
            issue=${url##*/}
            if (( count > 0 )); then
              echo "," >> 823-M09-data.json
            fi
            echo "Fetching $repo#$issue"
            gh issue view "$repo#$issue" \
              --json number,title,body,comments,labels,assignees,createdAt,updatedAt,htmlUrl \
              >> 823-M09-data.json
            ((count++))
          done < bonus-tasks/823-task-list.md

          echo "]" >> 823-M09-data.json
          echo "âœ… Generated 823-M09-data.json with $count entries"

      - name: Validate JSON format
        run: |
          if jq empty 823-M09-data.json; then
            echo "JSON is valid"
          else
            echo "Invalid JSON"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 823-M09-data
          path: 823-M09-data.json

