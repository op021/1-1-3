name: YAML M09ç²¾éˆ

on:
  workflow_dispatch:

jobs:
  GSACä»»å‹™è™•ç†:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ‹‰å–ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: å®‰è£GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update && sudo apt install gh jq -y

      - name: è¨­å®šGitHub CLIé©—è­‰
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: ç¢ºèªæª”æ¡ˆç›®éŒ„çµæ§‹
        run: |
          ls -la
          find . -name "*.md" -type f | head -10
          echo "å°‹æ‰¾ä»»å‹™æ¸…å–®æª”æ¡ˆ..."

      - name: å»ºç«‹æ¸¬è©¦ä»»å‹™æ¸…å–®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        run: |
          mkdir -p GSACè³é‡‘ä»»å‹™
          cat > GSACè³é‡‘ä»»å‹™/823-ä»»å‹™æ¸…å–®.md << EOF
          https://github.com/projectdiscovery/nuclei-templates/issues/12947
          https://github.com/projectdiscovery/nuclei-templates/issues/12946
          https://github.com/activepieces/activepieces/issues/8858
          https://github.com/activepieces/activepieces/issues/8854
          https://github.com/projectdiscovery/nuclei-templates/issues/12707
          https://github.com/activepieces/activepieces/issues/8589
          https://github.com/activepieces/activepieces/issues/8284
          https://github.com/activepieces/activepieces/issues/8236
          https://github.com/activepieces/activepieces/issues/8135
          EOF

      - name: é©—è­‰æª”æ¡ˆå…§å®¹
        run: |
          echo "æª”æ¡ˆå…§å®¹é è¦½ï¼š"
          cat GSACè³é‡‘ä»»å‹™/823-ä»»å‹™æ¸…å–®.md
          echo "ç¶²å€æ•¸é‡ï¼š"
          grep -c "https://github.com" GSACè³é‡‘ä»»å‹™/823-ä»»å‹™æ¸…å–®.md || echo "0"

      - name: æ‰¹æ¬¡æŠ“å–GitHub Issuesä¸¦ç”ŸæˆM09.json
        run: |
          echo "é–‹å§‹ç”ŸæˆM09.json..."
          echo "[" > M09.json
          
          # è¨ˆç®—ç¸½æ•¸é‡
          total=$(grep -c "https://github.com" GSACè³é‡‘ä»»å‹™/823-ä»»å‹™æ¸…å–®.md || echo "0")
          echo "ç¸½å…±éœ€è¦æŠ“å– $total å€‹Issue"
          
          counter=0
          
          # è®€å–æ¯ä¸€è¡ŒURL
          while IFS= read -r url; do
            # è·³éç©ºè¡Œå’Œä¸æ˜¯GitHub URLçš„è¡Œ
            if [[ -z "$url" || "$url" != *"github.com"* ]]; then
              continue
            fi
            
            # æå–owner/repoå’Œissue number
            repo_path=$(echo "$url" | sed 's|https://github.com/||' | sed 's|/issues/.*||')
            issue_num=$(echo "$url" | grep -oE '[0-9]+$')
            
            if [[ -n "$repo_path" && -n "$issue_num" ]]; then
              echo "ğŸ” æ­£åœ¨æŠ“å–: $repo_path#$issue_num"
              
              # å¦‚æœä¸æ˜¯ç¬¬ä¸€å€‹ï¼ŒåŠ é€—è™Ÿ
              if [ $counter -gt 0 ]; then
                echo "," >> M09.json
              fi
              
              # å˜—è©¦æŠ“å–Issueè³‡æ–™
              if gh issue view "$repo_path#$issue_num" --json number,title,body,comments,labels,assignees,createdAt,updatedAt,htmlUrl >> M09.json 2>/dev/null; then
                echo "âœ… æˆåŠŸæŠ“å–: $repo_path#$issue_num"
              else
                echo "âŒ æŠ“å–å¤±æ•—: $repo_path#$issue_num"
                # ç§»é™¤é€—è™Ÿå¦‚æœæ·»åŠ å¤±æ•—
                if [ $counter -gt 0 ]; then
                  sed -i '$d' M09.json
                fi
                continue
              fi
              
              counter=$((counter + 1))
            fi
          done < GSACè³é‡‘ä»»å‹™/823-ä»»å‹™æ¸…å–®.md
          
          echo "]" >> M09.json
          echo "âœ… M09.json ç”Ÿæˆå®Œç•¢ï¼ç¸½å…±è™•ç†äº† $counter å€‹Issues"

      - name: é©—è­‰ç”Ÿæˆçš„JSONæª”æ¡ˆ
        run: |
          echo "æª¢æŸ¥M09.jsonæª”æ¡ˆ..."
          if [ -f M09.json ]; then
            echo "æª”æ¡ˆå¤§å°: $(stat -f%z M09.json 2>/dev/null || stat -c%s M09.json) bytes"
            echo "æª”æ¡ˆå…§å®¹é è¦½ï¼ˆå‰50è¡Œï¼‰ï¼š"
            head -50 M09.json
            echo "..."
            echo "æª”æ¡ˆå…§å®¹é è¦½ï¼ˆå¾Œ10è¡Œï¼‰ï¼š"
            tail -10 M09.json
            
            # æª¢æŸ¥JSONæ ¼å¼
            if jq empty M09.json 2>/dev/null; then
              echo "âœ… JSONæ ¼å¼é©—è­‰é€šé"
            else
              echo "âŒ JSONæ ¼å¼éŒ¯èª¤"
              exit 1
            fi
          else
            echo "âŒ M09.jsonæª”æ¡ˆä¸å­˜åœ¨"
            exit 1
          fi

      - name: å»ºç«‹æ™‚é–“æˆ³æª”æ¡ˆ
        run: |
          date "+%Y-%m-%d %H:%M:%S UTC" > M09_timestamp.txt
          echo "SHA256: $(sha256sum M09.json | cut -d' ' -f1)" >> M09_timestamp.txt

      - name: ä¸Šå‚³æˆæœ
        uses: actions/upload-artifact@v4
        with:
          name: 823-M09æƒ…å ±æª”æ¡ˆ-$(date +%Y%m%d-%H%M%S)
          path: |
            M09.json
            M09_timestamp.txt
            GSACè³é‡‘ä»»å‹™/823-ä»»å‹™æ¸…å–®.md

      - name: é¡¯ç¤ºå®Œæˆæ‘˜è¦
        run: |
          echo "ğŸ‰ M09æƒ…å ±æª”æ¡ˆç”Ÿæˆå®Œæˆï¼"
          echo "ğŸ“ æª”æ¡ˆå·²ä¸Šå‚³è‡³Artifactsï¼Œå¯åœ¨Actionsé é¢ä¸‹è¼‰"
          echo "ğŸ” æª”æ¡ˆç°½ç« å·²è¨˜éŒ„åœ¨M09_timestamp.txtä¸­"
